<div class="form-container">
  <h2>Solicitar Nova Entrega</h2>

  <form [formGroup]="deliveryForm" (ngSubmit)="onSubmit()">
    <mat-radio-group formControlName="deliveryType" class="delivery-type-group">
      <mat-radio-button value="propria">Entrega Própria</mat-radio-button>
      <mat-radio-button value="parceira">Retirar em Outra Loja</mat-radio-button>
    </mat-radio-group>

    <!-- Loja de origem -->
    <mat-form-field
      appearance="outline"
      *ngIf="deliveryForm.get('deliveryType')?.value === 'parceira'"
    >
      <mat-label>Loja de Retirada</mat-label>
      <mat-select formControlName="origemId" required>
        <mat-option *ngFor="let loja of lojas$ | async" [value]="loja._id">
          {{ loja.nomeFantasia }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="deliveryForm.get('origemId')?.hasError('required')">
        Por favor, selecione a loja de origem.
      </mat-error>
    </mat-form-field>
    <mat-form-field appearance="outline" class="address-field">
      <mat-label>Endereço de Destino</mat-label>
      <input
        matInput
        type="text"
        formControlName="destinationAddress"
        placeholder="Digite o endereço..."
        [matAutocomplete]="auto"
      />
      <mat-autocomplete #auto="matAutocomplete">
        <mat-option
          *ngFor="let suggestion of suggestions"
          [value]="suggestion.description"
          (onSelectionChange)="selectSuggestion(suggestion)"
        >
          {{ suggestion.description }}
        </mat-option>
      </mat-autocomplete>
      
      <mat-error *ngIf="deliveryForm.get('destinationAddress')?.hasError('required')">
        Por favor, informe o endereço de destino.
      </mat-error>
      <mat-error *ngIf="deliveryForm.get('destinationCoords')?.hasError('required') && deliveryForm.get('destinationAddress')?.valid">
        Endereço inválido. Por favor, selecione uma opção da lista.
      </mat-error>
    </mat-form-field>

    <!-- Descrição -->
    <mat-form-field appearance="outline">
      <mat-label>Descrição do Item</mat-label>
      <input
        matInput
        formControlName="itemDescription"
        placeholder="Ex: Bateria Heliar HN60HD"
      />
      <mat-error *ngIf="deliveryForm.get('itemDescription')?.hasError('required')">
        A descrição é obrigatória.
      </mat-error>
    </mat-form-field>

    <div class="form-row">
  <mat-form-field appearance="outline" class="form-row-item">
    <mat-label>Nome do Cliente</mat-label>
    <input matInput formControlName="clienteNome" placeholder="Nome de quem vai receber">
    <mat-error *ngIf="deliveryForm.get('clienteNome')?.hasError('required')">
      Nome é obrigatório.
    </mat-error>
  </mat-form-field>

  <mat-form-field appearance="outline" class="form-row-item">
        <mat-label>Telefone do Cliente</mat-label>
        <input 
          matInput 
          formControlName="clienteTelefone" 
          placeholder="(00) 00000-0000" 
          mask="(00) 00000-0000">
        <mat-error *ngIf="deliveryForm.get('clienteTelefone')?.hasError('required')">
          Telefone é obrigatório.
        </mat-error>
      </mat-form-field>
</div>

<mat-form-field appearance="outline">
  <mat-label>Modalidade de Pagamento</mat-label>
  <mat-select formControlName="modalidadePagamento" required>
    <mat-option value="PIX">PIX</mat-option>
    <mat-option value="DINHEIRO">Dinheiro</mat-option>
    <mat-option value="CARTAO_MAQUININHA">Cartão (Maquininha)</mat-option>
  </mat-select>
  <mat-error *ngIf="deliveryForm.get('modalidadePagamento')?.hasError('required')">
    Selecione o pagamento.
  </mat-error>
</mat-form-field>

<mat-form-field appearance="outline">
  <mat-label>Observações</mat-label>
  <textarea matInput formControlName="observacoes" placeholder="Ex: Deixar na portaria, levar maquininha ou com troco para R$100..."></textarea>
</mat-form-field>

    <!-- Documento fiscal -->
    <div
      *ngIf="deliveryForm.get('deliveryType')?.value === 'propria'"
      class="documento-fiscal-container"
    >
      <mat-form-field appearance="outline" class="tipo-documento">
        <mat-label>Tipo de Documento</mat-label>
        <mat-select formControlName="tipoDocumento">
          <mat-option value="NF">Nota Fiscal (NF)</mat-option>
          <mat-option value="CUPOM_FISCAL">Cupom Fiscal</mat-option>
        </mat-select>
        <mat-error
          *ngIf="deliveryForm.get('tipoDocumento')?.hasError('required')"
        >
          Obrigatório
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="numero-documento">
        <mat-label>Número do Documento</mat-label>
        <input
          matInput
          formControlName="numeroDocumento"
          placeholder="Nº da NF ou Cupom"
        />
        <mat-error
          *ngIf="deliveryForm.get('numeroDocumento')?.hasError('required')"
        >
          Obrigatório
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Checkbox sucata -->
    <mat-checkbox formControlName="recolherSucata" class="sucata-checkbox">
      Será recolhida sucata (bateria antiga)?
    </mat-checkbox>

    <!-- Ações -->
    <div class="actions">
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="deliveryForm.invalid || isLoading"
      >
        <span *ngIf="!isLoading">Solicitar Entrega</span>
        <mat-spinner *ngIf="isLoading" diameter="24"></mat-spinner>
      </button>
    </div>

    <!-- Mensagens -->
    <div *ngIf="successMessage" class="success-message">
      {{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>
  </form>
</div>